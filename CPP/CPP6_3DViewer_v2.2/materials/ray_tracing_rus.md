# Рендеринг трассировкой лучей

Алгоритм трассировки лучей при своей концептуальной простоте связан с большим количеством вычислений, размер которых зависит от степени точности моделирования путешествия лучей по сцене. Как уже было сказано, на практике используется обратная трассировка лучей, то есть лучи исходят от наблюдателя, как в случае с ray casting. Тем не менее разница этих двух методов достаточно существенна, хотя некоторые из авторов учебных пособий и воспринимают эти два метода как синонимичные. 

В случае с обратной трассировкой лучей, лучи испускаемые от наблюдателя не просто устанавливают факт видимости объекта, но и определяют его визуальные свойства. Достаточно математически описать форму объекта сцены и задать некоторое количество коэффициентов, и, если модель поведения лучей описана достаточно подробно, будет получен и непосредственно цвет пикселя, без необходимости применения дополнительных подходов к закраске или вычислению цвета объекта. 

## Типы источников света

Интенсивность пикселя в наибольшей степени определяется степенью его освещенности. При обратной трассировке лучей это значит, что в общем случае, на видимость пикселя влияет тот факт, заканчивает ли свой путь луч в источнике света, потому что обратный ход луча, попадающего в глаз наблюдателю, по определению должен заканчиваться как раз в источнике света.

- Точечный источник - материальная точка в пространстве, испускающая лучи в разные стороны. На практике для обратной трассировки используется модель, определяемая точкой в пространстве и интенсивностью. Конечно, вероятность попадания луча в материальную точку в пространстве равна практически нулю. Поэтому интенсивность высчитывается исходя из косинуса угла между вектором проходящего рядом с источником луча и вектором, соединяющим точку последнего преломления и сам точечный источник.

- Направленное освещение - некоторые точечные источники света находятся настолько далеко и настолько яркие, как например, солнце, что его лучи можно считать параллельными. Таким образом, возможно описать источник света трехмерным вектором и интенсивностью. В данном случае, интенсивность каждого пикселя высчитывается исходя из косинуса угла между вектором покидающего сцену луча и направлением источника освещения.

- Глобальное освещение - некоторое фоновое значение интенсивности, или базовая интенсивность в тени. В реальном мире абсолютно черные тени встречаются чрезвычайно редко и не выглядят реалистичными. 

## Факторы, влияющие на маршрут луча.

В общем случае, чтобы вычислить освещенность отдельного пикселя, вычисляется количество света, вносимого каждым источником света, и складывается вместе, чтобы получить единое число, представляющее общее количество света, которое получает пиксель. Затем можно умножить цвет поверхности в этой точке на это количество, чтобы получить именно тот оттенок цвета, которым должен быть закрашен пиксель.

Магия трассировки лучей начинается в тот момент, когда возникает обработка столкновений лучей с объектами. 

### Матовость объектов

Первой характеристикой, влияющей на цвет пикселя и зависящую от свойств объекта, а не источника освещения, является матовость объекта. Вообще, на микроскопическом уровне, на котором и работает оптика, принято аппроксимировать все поверхности ровной плоскостью, то есть отразившийся луч высчитывать только в зависимости от установленных свойств объекта и нормали в этой точке, как будто луч просто отразился от плоскости. С этим понятием связана два вида отражения: диффузное отражение (diffuse reflection) и спекулярное (зеркальное) отражение (specular reflection). Матовые объекты обладают малым зеркальным отражением, а глянцевые - большим. У матовых объектов поверхность шероховатая, и лучи, при отражении, ведут себя немного более непредсказуемо, относительно нормали. Другими словами, чем чаще отразившиеся вектора оказываются близко к случаю, когда угол падения равен углу отражения, тем более глянцевым кажется объект. Итак, согласно закону Ламберта - падающий свет рассеивается во все стороны с одинаковой интенсивностью. Освещенность точки пропорциональна доле ее площади, видимой от источника.

$`I_p = I_a + \sum^n_{i=1} I_i \frac{\langle \vec{N},\vec{L_i} \rangle}{|\vec{N}||\vec{L_i}|}`$, где

$`I_p`$ - интенсивность в точке $`p`$

$`I_a`$ - фоновое значение интенсивности, рассеянный свет

$`I_i`$ - интенсивность $`i`$-ого источника света

$`\vec{N}`$ - вектор нормали полигона, встреченного в точке $`p`$

$`\vec{L_i}`$ - вектор, соединяющий центр полигона и источник освещения

Так же важно, что просуммированы должны быть только те члены, для которых выполняется $`\langle \vec{N},\vec{L_i} \rangle > 0`$, так как отрицательное скалярное произведение может произойти только в случае, если угол между нормалью и направлением источника света окажется тупым. Физический смысл такого явления заключается в том, что отрицательным как бы становится вектор нормали к поверхности. Подсвечивается обратная сторона полигона. Но так как мы работаем с непроницаемыми твердыми объектами, такой подход не имеет никакого смысла. Если же просто убрать это условие и не инвертировать нормаль, то отрицательная интенсивность будет делать данный полигон еще темнее, чем фоновая интенсивность, что тоже не имеет никакого смысла.

### Тени

Обычно тени разделяются на 2 типа: собственные и несобственные. Собственные тени возникают автоматически при соблюдении вышеуказанных соображений. С несобственными тенями, то есть тенями, отбрасываемыми на другие объекты, дела обстоят несколько сложнее. Для этого необходимо знать, перекрывают ли лучи от источников света к объектам другие объекты. Для этого используются дополнительные лучи, исходящие из источников света и фиксирующие первое пересечение с каким-либо объектом. Теперь, луч продолжает свое путешествие сквозь этот объект без преломлений, и если он фиксирует еще одно пересечение, то в этой точке объект не может быть освещен источником, испустившим луч. Расчет теней может быть оптимизирован, если использовать свойство теней, называемое когерентностью теней (shadow coherence). Свойство заключается в том, что если какая-то точка оказалась в тени объекта, то точка, располагающаяся рядом, тоже окажется в тени объекта. При поиске объектов между точкой и источником света, чтобы определить, находится ли точка в тени, обычно проверяется пересечения со всеми другими объектами. Однако, если известно, что точка непосредственно рядом с ней находится в тени определенного объекта, можно сначала проверить пересечения с этим объектом. Если оно будет найдено, значит не нужно проверять все остальные объекты.

### Зеркальные отражения

Зеркальное отражение - одно из основных свойств, выделяющих трассировку лучей. При трассировке лучей, достаточно просто учесть тот факт, что при попадании на зеркальную поверхность угол падения равен углу отражения, а цвет данной точки не является цветом объекта, а вычисляется в зависимости от цвета отраженного луча. Цвет после отражения может оказаться либо цветом фона, если после отражения луч покинул сцену, либо цветом другого объекта, если после отражения луч попал на этот объект. При этом, зеркальное отражение можно комбинировать с собственным цветом объекта и его диффузным отражением, задавая зеркальной поверхности цвет.

### Прозрачность и преломление

Попадая на полупрозрачные объекты, луч разбивается на два: отражающийся от объекта и проходящий сквозь и преломляющийся. Цвет в точке является суперпозицией двух полученных цветов, рассчитанных отслеживанием этих двух лучей. Степень прозрачности и преломления учитывается в соответствующих коэффициентах. В случае, если объект абсолютно прозрачен, то есть коэффициент прозрачности равен единице, отражения не происходит, и луч только преломляется. 

Но так как скорость распространения света зависит от среды, имеет место такое явление как преломление света. То есть луч света может преломляться в зависимости от того, в какую среду он попадает. Этот эффект становится заметными как раз на стыке двух разных сред, то есть по границам поверхностей объектов. Так как мы считаем, что наши объекты заполнены однородным материалом, можно полагать, что и коэффициент преломления на всем объеме объекта будет одинаковым. Тогда преломление луча можно посчитать исходя из закона Снелла:

$`\frac{sin\alpha_1}{sin\alpha_2} = \frac{n_2}{n_1}`$, где

$`\alpha_1`$ и $`\alpha_2`$ - угол между лучом и нормалью к поверхности до и после преломления

$`n_1`$ и $`n_2`$ - коэффициент преломления света для первой и второй среды

Обратите внимание, что преломление происходит не только, когда луч попадает в среду объекта, но и когда покидает ее, то есть каждый раз, когда среда меняется.

### Учет кривизны поверхности полигональных моделей

В случае с полигональными моделями, то есть моделями, состоящими из плоских граней, при использовании вышеупомянутых соображений в чистом виде может возникнуть проблема. Дело в том, что некоторые модели, предполагающие гладкие поверхности аппроксимированные полигонами, например полигональный шар или тор, будут выглядеть гранеными, в случае если используются нормали полигонов. Если же для каждой точки, аналогично методу закраски Фонга, аппроксимировать положение нормали исходя из нормалей к собственным вертексам полигонов, модели с твердыми ребрами, например куб, не будут выглядеть реалистично. В связи с этим, в случае трассировки лучей, необходимо предусмотреть режимы мягкости ребер: твердые ребра (hard edges) и мягкие (smooth edges) и использовать аппроксимированные нормали и нормали к поверхностям соответственно. В случае, когда в пределах одной модели присутствуют и первый и второй тип ребер, в случае обработки файла obj, всегда можно использовать интерполяцию нормалей для каждой точки, но в таком случае, для каждого полигона задать свои нормали. В случае если полигон должен иметь твердые ребра, все его вертексы должны иметь одинаковую нормаль, равную нормали к грани. В обратном случае, используются стандартные нормали к вертексам, равные сумме нормалей смежных полигонов. Некоторые obj файлы предоставляют исчерпывающую информацию о нормалях каждого вертекса каждого полигона (при этом один и тот же вертекс для разных полигонов может иметь разные нормали).
